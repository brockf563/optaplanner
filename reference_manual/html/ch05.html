<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter 5. Score Calculation</title><link rel="stylesheet" type="text/css" href="css/jbossorg.css"/><meta name="generator" content="DocBook XSL-NS Stylesheets V1.76.1"/><link rel="home" href="index.html" title="OptaPlanner User Guide"/><link rel="up" href="index.html" title="OptaPlanner User Guide"/><link rel="prev" href="ch04.html" title="Chapter 4. Planner Configuration"/><link rel="next" href="ch06.html" title="Chapter 6. Optimization Algorithms"/><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/></head><body><p id="title"><a href="http://www.jboss.org" class="site_href"><strong>JBoss.org</strong></a><a href="http://docs.jboss.org/" class="doc_href"><strong>Community Documentation</strong></a></p><ul class="docnav"><li class="previous"><a accesskey="p" href="ch04.html"><strong>Prev</strong></a></li><li class="next"><a accesskey="n" href="ch06.html"><strong>Next</strong></a></li></ul><div class="chapter" title="Chapter 5. Score Calculation"><div class="titlepage"><div><div><h2 class="title"><a id="scoreCalculation"/>Chapter 5. Score Calculation</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="ch05.html#scoreTerminology">5.1. Score Terminology</a></span></dt><dd><dl><dt><span class="section"><a href="ch05.html#whatIsAScore">5.1.1. What is a Score?</a></span></dt><dt><span class="section"><a href="ch05.html#scoreConstraintSignum">5.1.2. Score Constraint Signum (Positive or Negative)</a></span></dt><dt><span class="section"><a href="ch05.html#scoreConstraintWeight">5.1.3. Score Constraint Weight</a></span></dt><dt><span class="section"><a href="ch05.html#scoreLevel">5.1.4. Score Constraint Level (hard, soft, ...)</a></span></dt><dt><span class="section"><a href="ch05.html#paretoScoring">5.1.5. Pareto Scoring (AKA Multi-objective Optimization Scoring)</a></span></dt><dt><span class="section"><a href="ch05.html#combiningScoreTechniques">5.1.6. Combining Score Techniques</a></span></dt><dt><span class="section"><a href="ch05.html#scoreInterface">5.1.7. <code class="literal">Score</code> interface</a></span></dt><dt><span class="section"><a href="ch05.html#avoidFloatingPointNumbersInScoreCalculation">5.1.8. Avoid Floating Point Numbers in Score Calculation</a></span></dt></dl></dd><dt><span class="section"><a href="ch05.html#scoreDefinition">5.2. Choose a Score Definition</a></span></dt><dd><dl><dt><span class="section"><a href="ch05.html#simpleScore">5.2.1. SimpleScore</a></span></dt><dt><span class="section"><a href="ch05.html#hardSoftScore">5.2.2. HardSoftScore (Recommended)</a></span></dt><dt><span class="section"><a href="ch05.html#hardMediumSoftScore">5.2.3. HardMediumSoftScore</a></span></dt><dt><span class="section"><a href="ch05.html#bendableScore">5.2.4. BendableScore</a></span></dt><dt><span class="section"><a href="ch05.html#customScore">5.2.5. Implementing a Custom Score</a></span></dt></dl></dd><dt><span class="section"><a href="ch05.html#calculateTheScore">5.3. Calculate the <code class="literal">Score</code></a></span></dt><dd><dl><dt><span class="section"><a href="ch05.html#scoreCalculationTypes">5.3.1. Score Calculation Types</a></span></dt><dt><span class="section"><a href="ch05.html#easyJavaScoreCalculation">5.3.2. Easy Java Score Calculation</a></span></dt><dt><span class="section"><a href="ch05.html#incrementalJavaScoreCalculation">5.3.3. Incremental Java Score Calculation</a></span></dt><dt><span class="section"><a href="ch05.html#droolsScoreCalculation">5.3.4. Drools Score Calculation</a></span></dt><dt><span class="section"><a href="ch05.html#initializingScoreTrend">5.3.5. InitializingScoreTrend</a></span></dt><dt><span class="section"><a href="ch05.html#invalidScoreDetection">5.3.6. Invalid Score Detection</a></span></dt></dl></dd><dt><span class="section"><a href="ch05.html#scoreCalculationPerformanceTricks">5.4. Score Calculation Performance Tricks</a></span></dt><dd><dl><dt><span class="section"><a href="ch05.html#scoreCalculationPerformanceTricksOverview">5.4.1. Overview</a></span></dt><dt><span class="section"><a href="ch05.html#averageCalculationCountPerSecond">5.4.2. Average Calculation Count Per Second</a></span></dt><dt><span class="section"><a href="ch05.html#incrementalScoreCalculation">5.4.3. Incremental Score Calculation (with Deltas)</a></span></dt><dt><span class="section"><a href="ch05.html#avoidCallingRemoteServicesDuringScoreCalculation">5.4.4. Avoid Calling Remote Services During Score Calculation</a></span></dt><dt><span class="section"><a href="ch05.html#pointlessConstraints">5.4.5. Pointless Constraints</a></span></dt><dt><span class="section"><a href="ch05.html#buildInHardConstraint">5.4.6. Built-in Hard Constraint</a></span></dt><dt><span class="section"><a href="ch05.html#otherScoreCalculationPerformanceTricks">5.4.7. Other Score Calculation Performance Tricks</a></span></dt><dt><span class="section"><a href="ch05.html#scoreTrap">5.4.8. Score Trap</a></span></dt><dt><span class="section"><a href="ch05.html#stepLimitBenchmark">5.4.9. stepLimit Benchmark</a></span></dt><dt><span class="section"><a href="ch05.html#fairnessScoreConstraints">5.4.10. Fairness Score Constraints</a></span></dt></dl></dd><dt><span class="section"><a href="ch05.html#explainingTheScore">5.5. Explaining the Score: Using Score Calculation Outside the <code class="literal">Solver</code></a></span></dt></dl></div><div class="section" title="5.1. Score Terminology"><div class="titlepage"><div><div><h2 class="title"><a id="scoreTerminology"/>5.1. Score Terminology</h2></div></div></div><div class="section" title="5.1.1. What is a Score?"><div class="titlepage"><div><div><h3 class="title"><a id="whatIsAScore"/>5.1.1. What is a Score?</h3></div></div></div><p>Every initialized <code class="literal">Solution</code> has a score. The score is an objective way to compare two
      solutions. The solution with the higher score is better. The <code class="literal">Solver</code> aims to find the
      <code class="literal">Solution</code> with the highest <code class="literal">Score</code> of all possible solutions. The
      <span class="emphasis"><em>best solution</em></span> is the <code class="literal">Solution</code> with the highest <code class="literal">Score</code>
      that <code class="literal">Solver</code> has encountered during solving, which might be the <span class="emphasis"><em>optimal
      solution</em></span>.</p><p>Planner cannot automatically know which <code class="literal">Solution</code> is best for your business, so you need
      to tell it how to calculate the score of a given <code class="literal">Solution</code> according to your business needs. If
      you forget or are unable to implement an important business constraint, the solution is probably useless:</p><div class="mediaobject"><img src="images/Chapter-Score_calculation/optimalWithIncompleteConstraints.png"/></div><p>Defining constraints in Planner is very flexible through the following score techniques:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><span class="bold"><strong>Score signum (positive or negative)</strong></span>: maximize or minimize a constraint
          type</p></li><li class="listitem"><p><span class="bold"><strong>Score weight</strong></span>: put a cost/profit on a constraint type</p></li><li class="listitem"><p><span class="bold"><strong>Score level (hard, soft, ...)</strong></span>: prioritize a group of constraint
          types</p></li><li class="listitem"><p><span class="bold"><strong>Pareto scoring</strong></span></p></li></ul></div></div><div class="section" title="5.1.2. Score Constraint Signum (Positive or Negative)"><div class="titlepage"><div><div><h3 class="title"><a id="scoreConstraintSignum"/>5.1.2. Score Constraint Signum (Positive or Negative)</h3></div></div></div><p>All score techniques are based on constraints. A constraint can be a simple pattern (such as
      <span class="emphasis"><em>Maximize the apple harvest in the solution</em></span>) or a more complex pattern. A positive constraint
      is a constraint you want to maximize. A negative constraint is a constraint you want to minimize.</p><div class="mediaobject"><img src="images/Chapter-Score_calculation/positiveAndNegativeConstraints.png"/></div><p>The image above illustrates that <span class="bold"><strong>the optimal solution always has the highest
      score</strong></span>, regardless if the constraints are positive or negative.</p><p>Most planning problems have only negative constraints and therefore have a negative score. In that case, the
      score is the sum of the weight of the negative constraints being broken, with a perfect score of 0. This explains
      why the score of a solution of four queens is the negative of the number of queen pairs which can attack each
      other.</p><p>Negative and positive constraints can be combined, even in the same score level.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>Do not presume that your business knows all its score constraints in advance. Expect score constraints to
        be added or changed after the first releases.</p></div><p>When a constraint activates (because the negative constraint is broken or the positive constraint is
      fulfilled) on a certain planning entity set, it is called a <span class="emphasis"><em>constraint match</em></span>.</p></div><div class="section" title="5.1.3. Score Constraint Weight"><div class="titlepage"><div><div><h3 class="title"><a id="scoreConstraintWeight"/>5.1.3. Score Constraint Weight</h3></div></div></div><p>Not all score constraints are equally important. If breaking one constraint is equally bad as breaking
      another constraint x times, then those two constraints have a different weight (but they are in the same score
      level). For example in vehicle routing, you can make one "unhappy driver" constraint match count as much as two
      "fuel tank usage" constraint matches:</p><div class="mediaobject"><img src="images/Chapter-Score_calculation/scoreWeighting.png"/></div><p>Score weighting is often used in use cases where you can put a price tag on everything. In that case, the
      positive constraints maximize revenue and the negative constraints minimize expenses, so together they maximize
      profit. Alternatively, score weighting is also often used to create social <a class="link" href="ch05.html#fairnessScoreConstraints" title="5.4.10. Fairness Score Constraints">fairness</a>. For example, a nurse, who requests a free day, pays a higher
      weight on New Years eve than on a normal day.</p><p>Putting a good weight on a constraint can be a difficult analytical decision, because it is about making
      choices and tradeoffs with other constraints. However, a non-accurate weight is less damaging than mediocre
      algorithms:</p><div class="mediaobject"><img src="images/Chapter-Score_calculation/scoreTradeoffInPerspective.png"/></div><p>The weight of a constraint match can be dynamically based on the planning entities involved. For example in
      cloud balance, the weight of the soft constraint match for an active <code class="literal">Computer</code> is the
      <code class="literal">cost</code> of that <code class="literal">Computer</code> (which differs per computer).</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>Furthermore, it is often useful to allow the end-user to recalibrate constraint weights in the user
        interface, as demonstrated in the exam timetabling example with the
        <code class="literal">InstitutionParametrization</code> class.</p></div></div><div class="section" title="5.1.4. Score Constraint Level (hard, soft, ...)"><div class="titlepage"><div><div><h3 class="title"><a id="scoreLevel"/>5.1.4. Score Constraint Level (hard, soft, ...)</h3></div></div></div><p>Sometimes a score constraint outranks another score constraint, no matter how many times the other is
      broken. In that case, those score constraints are in different levels. For example, a nurse cannot do 2 shifts at
      the same time (due to the constraints of physical reality), this outranks all nurse happiness constraints.</p><p>Most use cases have only two score levels, hard and soft. Two scores are compared lexicographically. The
      first score level gets compared first. If those differ, the others score levels are ignored. For example, a score
      that breaks <code class="literal">0</code> hard constraints and <code class="literal">1000000</code> soft constraints is better than a
      score that breaks <code class="literal">1</code> hard constraint and <code class="literal">0</code> soft constraints.</p><div class="mediaobject"><img src="images/Chapter-Score_calculation/scoreLevels.png"/></div><p>If there are two (or more) score levels, for example a hard and soft level, then a score is feasible if no
      hard constraints are broken.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>By default, Planner will always assign all planning variables a planning value. If there is no feasible
        solution, this means the best solution will be unfeasible. To instead leave some of the planning entities
        unassigned, apply <a class="link" href="ch15.html#overconstrainedPlanning" title="15.3. Overconstrained Planning">overconstrained planning</a>.</p></div><p>For each constraint, you need to pick a score level, a score weight and a score signum. For example:
      <code class="literal">-1soft</code> which has score level of <code class="literal">soft</code>, a weight of <code class="literal">1</code> and a
      negative signum. Do not use a big constraint weight when your business actually wants different score levels. That
      hack, known as <span class="emphasis"><em>score folding</em></span>, is broken:</p><div class="mediaobject"><img src="images/Chapter-Score_calculation/scoreFoldingIsBroken.png"/></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>Your business might tell you that your hard constraints all have the same weight, because they cannot be
        broken (so the weight does not matter). This is not true because if no feasible solution exists for a specific
        dataset, the least infeasible solution allows the business to estimate how many business resources they are
        lacking. For example in cloud balancing, how many new computers to buy.</p><p>Furthermore, it will likely create a <a class="link" href="ch05.html#scoreTrap" title="5.4.8. Score Trap">score trap</a>. For example in cloud
        balance if a <code class="literal">Computer</code> has seven CPU too little for its <code class="literal">Process</code>es, then it
        must be weighted seven times as much as if it had only one CPU too little.</p></div><p>Three or more score levels are supported. For example: a company might decide that profit outranks employee
      satisfaction (or visa versa), while both are outranked by the constraints of physical reality.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>To model fairness or load balancing, there is <a class="link" href="ch05.html#fairnessScoreConstraints" title="5.4.10. Fairness Score Constraints">no need to use lots
        of score levels</a> (even though Planner can handle many score levels).</p></div></div><div class="section" title="5.1.5. Pareto Scoring (AKA Multi-objective Optimization Scoring)"><div class="titlepage"><div><div><h3 class="title"><a id="paretoScoring"/>5.1.5. Pareto Scoring (AKA Multi-objective Optimization Scoring)</h3></div></div></div><p>Far less common is the use case of pareto optimization, which is also known under the more confusing term
      multi-objective optimization. In pareto scoring, score constraints are in the same score level, yet they are not
      weighted against each other. When two scores are compared, each of the score constraints are compared individually
      and the score with the most dominating score constraints wins. Pareto scoring can even be combined with score
      levels and score constraint weighting.</p><p>Consider this example with positive constraints, where we want to get the most apples and oranges. Since it
      is impossible to compare apples and oranges, we can not weight them against each other. Yet, despite that we can
      not compare them, we can state that two apples are better then one apple. Similarly, we can state that two apples
      and one orange are better than just one orange. So despite our inability to compare some Scores conclusively (at
      which point we declare them equal), we can find a set of optimal scores. Those are called pareto optimal.</p><div class="mediaobject"><img src="images/Chapter-Score_calculation/paretoOptimizationScoring.png"/></div><p>Scores are considered equal far more often. It is left up to a human to choose the better out of a set of
      best solutions (with equal scores) found by Planner. In the example above, the user must choose between solution A
      (three apples and one orange) and solution B (one apple and six oranges). It is guaranteed that Planner has not
      found another solution which has more apples or more oranges or even a better combination of both (such as two
      apples and three oranges).</p><p>To implement pareto scoring in Planner, <a class="link" href="ch05.html#customScore" title="5.2.5. Implementing a Custom Score">implement a custom
      <code class="literal">ScoreDefinition</code> and <code class="literal">Score</code></a> (and replace the
      <code class="literal">BestSolutionRecaller</code>). Future versions will provide out-of-the-box support.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>A pareto <code class="literal">Score</code>'s <code class="literal">compareTo</code> method is not transitive because it does
        a pareto comparison. For example: having two apples is greater than one apple. One apple is equal to One orange.
        Yet, two apples are not greater than one orange (but actually equal). Pareto comparison violates the contract of
        the interface <code class="literal">java.lang.Comparable</code>'s <code class="literal">compareTo</code> method, but Planners
        systems are <span class="emphasis"><em>pareto comparison safe</em></span>, unless explicitly stated otherwise in this
        documentation.</p></div></div><div class="section" title="5.1.6. Combining Score Techniques"><div class="titlepage"><div><div><h3 class="title"><a id="combiningScoreTechniques"/>5.1.6. Combining Score Techniques</h3></div></div></div><p>All the score techniques mentioned above, can be combined seamlessly:</p><div class="mediaobject"><img src="images/Chapter-Score_calculation/scoreComposition.png"/></div></div><div class="section" title="5.1.7. Score interface"><div class="titlepage"><div><div><h3 class="title"><a id="scoreInterface"/>5.1.7. <code class="literal">Score</code> interface</h3></div></div></div><p>A score is represented by the <code class="literal">Score</code> interface, which naturally extends
      <code class="literal">Comparable</code>:</p><pre><code class="language-java">public interface Score&lt;...&gt; extends Comparable&lt;...&gt; {
    ...
}</code></pre><p>The <code class="literal">Score</code> implementation to use depends on your use case. Your score might not
      efficiently fit in a single <code class="literal">long</code> value. Planner has several built-in <code class="literal">Score</code>
      implementations, but you can implement a custom <code class="literal">Score</code> too. Most use cases tend to use the
      built-in <code class="literal">HardSoftScore</code>.</p><div class="mediaobject"><img src="images/Chapter-Score_calculation/scoreClassDiagram.png"/></div><p>The <code class="literal">Score</code> implementation (for example <code class="literal">HardSoftScore</code>) must be the same
      throughout a <code class="literal">Solver</code> runtime. The <code class="literal">Score</code> implementation is configured in the
      solver configuration as a ScoreDefinition:</p><pre><code class="language-xml">  &lt;scoreDirectorFactory&gt;
    &lt;scoreDefinitionType&gt;HARD_SOFT&lt;/scoreDefinitionType&gt;
    ...
  &lt;/scoreDirectorFactory&gt;</code></pre></div><div class="section" title="5.1.8. Avoid Floating Point Numbers in Score Calculation"><div class="titlepage"><div><div><h3 class="title"><a id="avoidFloatingPointNumbersInScoreCalculation"/>5.1.8. Avoid Floating Point Numbers in Score Calculation</h3></div></div></div><p>Avoid the use of <code class="literal">float</code> and <code class="literal">double</code> for score calculation. Use
      <code class="literal">BigDecimal</code> instead.</p><p>Floating point numbers (<code class="literal">float</code> and <code class="literal">double</code>) cannot represent a decimal
      number correctly. For example: a <code class="literal">double</code> cannot hold the value <code class="literal">0.05</code>
      correctly. Instead, it holds the nearest representable value. Arithmetic (including addition and subtraction) with
      floating point numbers, especially for planning problems, leads to incorrect decisions:</p><div class="mediaobject"><img src="images/Chapter-Score_calculation/scoreWeightType.png"/></div><p>Additionally, floating point number addition is not associative:</p><pre><code class="language-java">System.out.println( ((0.01 + 0.02) + 0.03) == (0.01 + (0.02 + 0.03)) ); // returns false</code></pre><p>This leads to <span class="emphasis"><em>score corruption</em></span>.</p><p>Decimal numbers (<code class="literal">BigDecimal</code>) have none of these problems.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>BigDecimal arithmetic is considerably slower than <code class="literal">int</code>, <code class="literal">long</code> or
        <code class="literal">double</code> arithmetic. In experiments we have seen the average calculation count get divided by
        5.</p><p>Therefore, in some cases, it can be worthwhile to multiply <span class="emphasis"><em>all</em></span> numbers for a single
        score weight by a plural of ten (for example <code class="literal">1000</code>), so the score weight fits in an
        <code class="literal">int</code> or <code class="literal">long</code>.</p></div></div></div><div class="section" title="5.2. Choose a Score Definition"><div class="titlepage"><div><div><h2 class="title"><a id="scoreDefinition"/>5.2. Choose a Score Definition</h2></div></div></div><p>Each <code class="literal">Score</code> implementation also has a <code class="literal">ScoreDefinition</code> implementation. For
    example: <code class="literal">SimpleScore</code> is defined by <code class="literal">SimpleScoreDefinition</code>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>To properly write a <code class="literal">Score</code> to database (with JPA/Hibernate) or to XML/JSON (with
      XStream/JAXB), see <a class="link" href="ch16.html" title="Chapter 16. Integration">the integration chapter</a>.</p></div><div class="section" title="5.2.1. SimpleScore"><div class="titlepage"><div><div><h3 class="title"><a id="simpleScore"/>5.2.1. SimpleScore</h3></div></div></div><p>A <code class="literal">SimpleScore</code> has a single <code class="literal">int</code> value, for example
      <code class="literal">-123</code>. It has a single score level.</p><pre><code class="language-xml">  &lt;scoreDirectorFactory&gt;
    &lt;scoreDefinitionType&gt;SIMPLE&lt;/scoreDefinitionType&gt;
    ...
  &lt;/scoreDirectorFactory&gt;</code></pre><p>Variants of this <code class="literal">scoreDefinitionType</code>:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="literal">SIMPLE_LONG</code>: Uses <code class="literal">SimpleLongScore</code> which has a
          <code class="literal">long</code> value instead of an <code class="literal">int</code> value.</p></li><li class="listitem"><p><code class="literal">SIMPLE_DOUBLE</code>: Uses <code class="literal">SimpleDoubleScore</code> which has a
          <code class="literal">double</code> value instead of an <code class="literal">int</code> value. <a class="link" href="ch05.html#avoidFloatingPointNumbersInScoreCalculation" title="5.1.8. Avoid Floating Point Numbers in Score Calculation">Not recommended to use.</a></p></li><li class="listitem"><p><code class="literal">SIMPLE_BIG_DECIMAL</code>: Uses <code class="literal">SimpleBigDecimalScore</code> which has a
          <code class="literal">BigDecimal</code> value instead of an <code class="literal">int</code> value.</p></li></ul></div></div><div class="section" title="5.2.2. HardSoftScore (Recommended)"><div class="titlepage"><div><div><h3 class="title"><a id="hardSoftScore"/>5.2.2. HardSoftScore (Recommended)</h3></div></div></div><p>A <code class="literal">HardSoftScore</code> has a hard <code class="literal">int</code> value and a soft <code class="literal">int</code>
      value, for example <code class="literal">-123hard/-456soft</code>. It has 2 score levels (hard and soft).</p><pre><code class="language-xml">  &lt;scoreDirectorFactory&gt;
    &lt;scoreDefinitionType&gt;HARD_SOFT&lt;/scoreDefinitionType&gt;
    ...
  &lt;/scoreDirectorFactory&gt;</code></pre><p>Variants of this <code class="literal">scoreDefinitionType</code>:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="literal">HARD_SOFT_LONG</code>: Uses <code class="literal">HardSoftLongScore</code> which has
          <code class="literal">long</code> values instead of <code class="literal">int</code> values.</p></li><li class="listitem"><p><code class="literal">HARD_SOFT_DOUBLE</code>: Uses <code class="literal">HardSoftDoubleScore</code> which has
          <code class="literal">double</code> values instead of <code class="literal">int</code> values. <a class="link" href="ch05.html#avoidFloatingPointNumbersInScoreCalculation" title="5.1.8. Avoid Floating Point Numbers in Score Calculation">Not recommended to use.</a></p></li><li class="listitem"><p><code class="literal">HARD_SOFT_BIG_DECIMAL</code>: Uses <code class="literal">HardSoftBigDecimalScore</code> which has
          <code class="literal">BigDecimal</code> values instead of <code class="literal">int</code> values.</p></li></ul></div></div><div class="section" title="5.2.3. HardMediumSoftScore"><div class="titlepage"><div><div><h3 class="title"><a id="hardMediumSoftScore"/>5.2.3. HardMediumSoftScore</h3></div></div></div><p>A <code class="literal">HardMediumSoftScore</code> which has a hard <code class="literal">int</code> value, a medium
      <code class="literal">int</code> value and a soft <code class="literal">int</code> value, for example
      <code class="literal">-123hard/-456medium/-789soft</code>. It has 3 score levels (hard, medium and soft).</p><pre><code class="language-xml">  &lt;scoreDirectorFactory&gt;
    &lt;scoreDefinitionType&gt;HARD_MEDIUM_SOFT&lt;/scoreDefinitionType&gt;
    ...
  &lt;/scoreDirectorFactory&gt;</code></pre><p>Variants of this <code class="literal">scoreDefinitionType</code>:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="literal">HARD_MEDIUM_SOFT_LONG</code>: Uses <code class="literal">HardMediumSoftLongScore</code> which has
          <code class="literal">long</code> values instead of <code class="literal">int</code> values.</p></li></ul></div></div><div class="section" title="5.2.4. BendableScore"><div class="titlepage"><div><div><h3 class="title"><a id="bendableScore"/>5.2.4. BendableScore</h3></div></div></div><p>A <code class="literal">BendableScore</code> has a configurable number of score levels. It has an array of hard
      <code class="literal">int</code> values and an array of soft <code class="literal">int</code> value, for example with 2 hard levels
      and 3 soft levels, the score can be <code class="literal">-123/-456/-789/-012/-345</code>.</p><pre><code class="language-xml">  &lt;scoreDirectorFactory&gt;
    &lt;scoreDefinitionType&gt;BENDABLE&lt;/scoreDefinitionType&gt;
    &lt;bendableHardLevelsSize&gt;2&lt;/bendableHardLevelsSize&gt;
    &lt;bendableSoftLevelsSize&gt;3&lt;/bendableSoftLevelsSize&gt;
    ...
  &lt;/scoreDirectorFactory&gt;</code></pre><p>The number of hard and soft score levels needs to be set at configuration time. It is not flexible to change
      during solving.</p><p>Variants of this <code class="literal">scoreDefinitionType</code>:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="literal">BENDABLE_Long</code>: Uses <code class="literal">BendableLongScore</code> which has
          <code class="literal">long</code> values instead of <code class="literal">int</code> values.</p></li><li class="listitem"><p><code class="literal">BENDABLE_BIG_DECIMAL</code>: Uses <code class="literal">BendableBigDecimalScore</code> which has
          <code class="literal">BigDecimal</code> values instead of <code class="literal">int</code> values.</p></li></ul></div></div><div class="section" title="5.2.5. Implementing a Custom Score"><div class="titlepage"><div><div><h3 class="title"><a id="customScore"/>5.2.5. Implementing a Custom Score</h3></div></div></div><p>The <code class="literal">ScoreDefinition</code> interface defines the score representation.</p><p>To implement a custom <code class="literal">Score</code>, you will also need to implement a custom
      <code class="literal">ScoreDefinition</code>. Extend <code class="literal">AbstractScoreDefinition</code> (preferably by copy pasting
      <code class="literal">HardSoftScoreDefinition</code>) and start from there.</p><p>Then hook your custom <code class="literal">ScoreDefinition</code> in your
      <code class="filename">SolverConfig.xml</code>:</p><pre><code class="language-xml">  &lt;scoreDirectorFactory&gt;
    &lt;scoreDefinitionClass&gt;...MyScoreDefinition&lt;/scoreDefinitionClass&gt;
    ...
  &lt;/scoreDirectorFactory&gt;</code></pre><p>To have it integrate seamlessly with <a class="link" href="ch16.html#jpaAndHibernatePersistingAScore" title="16.2.1.1. JPA and Hibernate: Persisting a Score">JPA/Hibernate</a>,
      <a class="link" href="ch16.html#integrationWithXStream" title="16.2.2. XML or JSON: XStream">XStream</a>, ... you might need to write some glue code.</p></div></div><div class="section" title="5.3. Calculate the Score"><div class="titlepage"><div><div><h2 class="title"><a id="calculateTheScore"/>5.3. Calculate the <code class="literal">Score</code></h2></div></div></div><div class="section" title="5.3.1. Score Calculation Types"><div class="titlepage"><div><div><h3 class="title"><a id="scoreCalculationTypes"/>5.3.1. Score Calculation Types</h3></div></div></div><p>There are several ways to calculate the <code class="literal">Score</code> of a <code class="literal">Solution</code>:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><span class="bold"><strong>Easy Java score calculation</strong></span>: implement a single Java method</p></li><li class="listitem"><p><span class="bold"><strong>Incremental Java score calculation</strong></span>: implement multiple Java
          methods</p></li><li class="listitem"><p><span class="bold"><strong>Drools score calculation</strong></span> (recommended): implement score rules</p></li></ul></div><p>Every score calculation type can use any Score definition. For example, easy Java score calculation can
      output a <code class="literal">HardSoftScore</code>.</p><p>All score calculation types are Object Oriented and can reuse existing Java code.</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2><p>The score calculation must be read-only. It must not change the planning entities or the problem facts in
        any way. For example, it must not call a setter method on a planning entity in a Drools score rule's RHS. This
        does not apply to <span class="emphasis"><em>logically inserted</em></span> objects, which can be changed by the score rules that
        logically inserted them in the first place.</p><p>Planner will not recalculate the score of a <code class="literal">Solution</code> if it can predict it (unless an
        <a class="link" href="ch04.html#environmentMode" title="4.4.3. Environment Mode: Are There Bugs in my Code?">environmentMode assertion</a> is enabled). For example, after a winning step
        is done, there is no need to calculate the score because that move was done and undone earlier. As a result,
        there is no guarantee that such changes applied during score calculation are actually done.</p></div></div><div class="section" title="5.3.2. Easy Java Score Calculation"><div class="titlepage"><div><div><h3 class="title"><a id="easyJavaScoreCalculation"/>5.3.2. Easy Java Score Calculation</h3></div></div></div><p>An easy way to implement your score calculation in Java.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Advantages:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Plain old Java: no learning curve</p></li><li class="listitem"><p>Opportunity to delegate score calculation to an existing code base or legacy system</p></li></ul></div></li><li class="listitem"><p>Disadvantages:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Slower and less scalable</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Because there is no <a class="link" href="ch05.html#incrementalScoreCalculation" title="5.4.3. Incremental Score Calculation (with Deltas)">incremental score
                  calculation</a></p></li></ul></div></li></ul></div></li></ul></div><p>Just implement one method of the interface <code class="literal">EasyScoreCalculator</code>:</p><pre><code class="language-java">public interface EasyScoreCalculator&lt;Sol extends Solution&gt; {

    Score calculateScore(Sol solution);
   
}</code></pre><p>For example in n queens:</p><pre><code class="language-java">public class NQueensEasyScoreCalculator implements EasyScoreCalculator&lt;NQueens&gt; {

    public SimpleScore calculateScore(NQueens nQueens) {
        int n = nQueens.getN();
        List&lt;Queen&gt; queenList = nQueens.getQueenList();
        
        int score = 0;
        for (int i = 0; i &lt; n; i++) {
            for (int j = i + 1; j &lt; n; j++) {
                Queen leftQueen = queenList.get(i);
                Queen rightQueen = queenList.get(j);
                if (leftQueen.getRow() != null &amp;&amp; rightQueen.getRow() != null) {
                    if (leftQueen.getRowIndex() == rightQueen.getRowIndex()) {
                        score--;
                    }
                    if (leftQueen.getAscendingDiagonalIndex() == rightQueen.getAscendingDiagonalIndex()) {
                        score--;
                    }
                    if (leftQueen.getDescendingDiagonalIndex() == rightQueen.getDescendingDiagonalIndex()) {
                        score--;
                    }
                }
            }
        }
        return SimpleScore.valueOf(score);
    }

}</code></pre><p>Configure it in your solver configuration:</p><pre><code class="language-xml">  &lt;scoreDirectorFactory&gt;
    &lt;scoreDefinitionType&gt;...&lt;/scoreDefinitionType&gt;
    &lt;easyScoreCalculatorClass&gt;org.optaplanner.examples.nqueens.solver.score.NQueensEasyScoreCalculator&lt;/easyScoreCalculatorClass&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre><p>Alternatively, build a <code class="literal">EasyScoreCalculator</code> instance at runtime and set it with the
      programmatic API:</p><pre><code class="language-java">    solverFactory.getSolverConfig().getScoreDirectorFactoryConfig.setEasyScoreCalculator(easyScoreCalculator);</code></pre></div><div class="section" title="5.3.3. Incremental Java Score Calculation"><div class="titlepage"><div><div><h3 class="title"><a id="incrementalJavaScoreCalculation"/>5.3.3. Incremental Java Score Calculation</h3></div></div></div><p>A way to implement your score calculation incrementally in Java.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Advantages:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Very fast and scalable</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Currently the fastest if implemented correctly</p></li></ul></div></li></ul></div></li><li class="listitem"><p>Disadvantages:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Hard to write</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>A scalable implementation heavily uses maps, indexes, ... (things the Drools rule engine can do
                  for you)</p></li><li class="listitem"><p>You have to learn, design, write and improve all these performance optimizations yourself</p></li></ul></div></li><li class="listitem"><p>Hard to read</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Regular score constraint changes can lead to a high maintenance cost</p></li></ul></div></li></ul></div></li></ul></div><p>Implement all the methods of the interface <code class="literal">IncrementalScoreCalculator</code> and extend the
      class <code class="literal">AbstractIncrementalScoreCalculator</code>:</p><pre><code class="language-java">public interface IncrementalScoreCalculator&lt;Sol extends Solution&gt; {

    void resetWorkingSolution(Sol workingSolution);

    void beforeEntityAdded(Object entity);

    void afterEntityAdded(Object entity);

    void beforeVariableChanged(Object entity, String variableName);

    void afterVariableChanged(Object entity, String variableName);

    void beforeEntityRemoved(Object entity);

    void afterEntityRemoved(Object entity);

    Score calculateScore();
    
}</code></pre><div class="mediaobject"><img src="images/Chapter-Score_calculation/incrementalScoreCalculatorSequenceDiagram.png"/></div><p>For example in n queens:</p><pre><code class="language-java">public class NQueensAdvancedIncrementalScoreCalculator extends AbstractIncrementalScoreCalculator&lt;NQueens&gt; {

    private Map&lt;Integer, List&lt;Queen&gt;&gt; rowIndexMap;
    private Map&lt;Integer, List&lt;Queen&gt;&gt; ascendingDiagonalIndexMap;
    private Map&lt;Integer, List&lt;Queen&gt;&gt; descendingDiagonalIndexMap;

    private int score;

    public void resetWorkingSolution(NQueens nQueens) {
        int n = nQueens.getN();
        rowIndexMap = new HashMap&lt;Integer, List&lt;Queen&gt;&gt;(n);
        ascendingDiagonalIndexMap = new HashMap&lt;Integer, List&lt;Queen&gt;&gt;(n * 2);
        descendingDiagonalIndexMap = new HashMap&lt;Integer, List&lt;Queen&gt;&gt;(n * 2);
        for (int i = 0; i &lt; n; i++) {
            rowIndexMap.put(i, new ArrayList&lt;Queen&gt;(n));
            ascendingDiagonalIndexMap.put(i, new ArrayList&lt;Queen&gt;(n));
            descendingDiagonalIndexMap.put(i, new ArrayList&lt;Queen&gt;(n));
            if (i != 0) {
                ascendingDiagonalIndexMap.put(n - 1 + i, new ArrayList&lt;Queen&gt;(n));
                descendingDiagonalIndexMap.put((-i), new ArrayList&lt;Queen&gt;(n));
            }
        }
        score = 0;
        for (Queen queen : nQueens.getQueenList()) {
            insert(queen);
        }
    }

    public void beforeEntityAdded(Object entity) {
        // Do nothing
    }

    public void afterEntityAdded(Object entity) {
        insert((Queen) entity);
    }

    public void beforeVariableChanged(Object entity, String variableName) {
        retract((Queen) entity);
    }

    public void afterVariableChanged(Object entity, String variableName) {
        insert((Queen) entity);
    }

    public void beforeEntityRemoved(Object entity) {
        retract((Queen) entity);
    }

    public void afterEntityRemoved(Object entity) {
        // Do nothing
    }

    private void insert(Queen queen) {
        Row row = queen.getRow();
        if (row != null) {
            int rowIndex = queen.getRowIndex();
            List&lt;Queen&gt; rowIndexList = rowIndexMap.get(rowIndex);
            score -= rowIndexList.size();
            rowIndexList.add(queen);
            List&lt;Queen&gt; ascendingDiagonalIndexList = ascendingDiagonalIndexMap.get(queen.getAscendingDiagonalIndex());
            score -= ascendingDiagonalIndexList.size();
            ascendingDiagonalIndexList.add(queen);
            List&lt;Queen&gt; descendingDiagonalIndexList = descendingDiagonalIndexMap.get(queen.getDescendingDiagonalIndex());
            score -= descendingDiagonalIndexList.size();
            descendingDiagonalIndexList.add(queen);
        }
    }

    private void retract(Queen queen) {
        Row row = queen.getRow();
        if (row != null) {
            List&lt;Queen&gt; rowIndexList = rowIndexMap.get(queen.getRowIndex());
            rowIndexList.remove(queen);
            score += rowIndexList.size();
            List&lt;Queen&gt; ascendingDiagonalIndexList = ascendingDiagonalIndexMap.get(queen.getAscendingDiagonalIndex());
            ascendingDiagonalIndexList.remove(queen);
            score += ascendingDiagonalIndexList.size();
            List&lt;Queen&gt; descendingDiagonalIndexList = descendingDiagonalIndexMap.get(queen.getDescendingDiagonalIndex());
            descendingDiagonalIndexList.remove(queen);
            score += descendingDiagonalIndexList.size();
        }
    }

    public SimpleScore calculateScore() {
        return SimpleScore.valueOf(score);
    }

}</code></pre><p>Configure it in your solver configuration:</p><pre><code class="language-xml">  &lt;scoreDirectorFactory&gt;
    &lt;scoreDefinitionType&gt;...&lt;/scoreDefinitionType&gt;
    &lt;incrementalScoreCalculatorClass&gt;org.optaplanner.examples.nqueens.solver.score.NQueensAdvancedIncrementalScoreCalculator&lt;/incrementalScoreCalculatorClass&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre><p>Optionally, to explain a score with <code class="literal">ScoreDirector.getConstraintMatchTotals()</code> or to get
      better output when the <code class="literal">IncrementalScoreCalculator</code> is corrupted in
      <code class="literal">FAST_ASSERT</code> or <code class="literal">FULL_ASSERT environmentMode</code>, implement also the
      <code class="literal">ConstraintMatchAwareIncrementalScoreCalculator</code> interface:</p><pre><code class="language-java">public interface ConstraintMatchAwareIncrementalScoreCalculator&lt;Sol extends Solution&gt; {

    void resetWorkingSolution(Sol workingSolution, boolean constraintMatchEnabled);

    Collection&lt;ConstraintMatchTotal&gt; getConstraintMatchTotals();
    
}</code></pre></div><div class="section" title="5.3.4. Drools Score Calculation"><div class="titlepage"><div><div><h3 class="title"><a id="droolsScoreCalculation"/>5.3.4. Drools Score Calculation</h3></div></div></div><div class="section" title="5.3.4.1. Overview"><div class="titlepage"><div><div><h4 class="title"><a id="droolsScoreCalculationOverview"/>5.3.4.1. Overview</h4></div></div></div><p>Implement your score calculation using the Drools rule engine. Every score constraint is written as one or
        more score rules.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Advantages:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Incremental score calculation for free</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Because most DRL syntax uses forward chaining, it does incremental calculation without any
                    extra code</p></li></ul></div></li><li class="listitem"><p>Score constraints are isolated as separate rules</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Easy to add or edit existing score rules</p></li></ul></div></li><li class="listitem"><p>Flexibility to augment your score constraints by</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Defining them in decision tables</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Excel (XLS) spreadsheet</p></li><li class="listitem"><p>KIE Workbench WebUI</p></li></ul></div></li><li class="listitem"><p>Translate them into natural language with DSL</p></li><li class="listitem"><p>Store and release in the KIE Workbench repository</p></li></ul></div></li><li class="listitem"><p>Performance optimizations in future versions for free</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>In every release, the Drools rule engine tends to become faster</p></li></ul></div></li></ul></div></li><li class="listitem"><p>Disadvantages:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>DRL learning curve</p></li><li class="listitem"><p>Usage of DRL</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Polyglot fear can prohibit the use of a new language such as DRL in some organizations</p></li></ul></div></li></ul></div></li></ul></div></div><div class="section" title="5.3.4.2. Drools Score Rules Configuration"><div class="titlepage"><div><div><h4 class="title"><a id="droolsScoreRulesConfiguration"/>5.3.4.2. Drools Score Rules Configuration</h4></div></div></div><p>There are several ways to define where your score rules live.</p><div class="section" title="5.3.4.2.1. A scoreDrl Resource on the Classpath"><div class="titlepage"><div><div><h5 class="title"><a id="droolsScoreCalculationScoreDrl"/>5.3.4.2.1. A scoreDrl Resource on the Classpath</h5></div></div></div><p>This is the easy way. The score rules live in a DRL file which is provided as a classpath resource. Just
          add the score rules DRL file in the solver configuration as a <code class="literal">&lt;scoreDrl&gt;</code>
          element:</p><pre><code class="language-xml">  &lt;scoreDirectorFactory&gt;
    &lt;scoreDefinitionType&gt;...&lt;/scoreDefinitionType&gt;
    &lt;scoreDrl&gt;org/optaplanner/examples/nqueens/solver/nQueensScoreRules.drl&lt;/scoreDrl&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre><p>In a typical project (following the Maven directory structure), that DRL file would be located at
          <code class="literal">$PROJECT_DIR/src/main/resources/org/optaplanner/examples/nqueens/solver/nQueensScoreRules.drl</code>
          (even for a war project).</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>The <code class="literal">&lt;scoreDrl&gt;</code> element expects a classpath resource, as defined by
            <code class="literal">ClassLoader.getResource(String)</code>, it does not accept a <code class="literal">File</code>, nor an
            URL, nor a webapp resource. See below to use a <code class="literal">File</code> instead.</p></div><p>Add multiple <code class="literal">&lt;scoreDrl&gt;</code> elements if the score rules are split across multiple
          DRL files.</p><p>Optionally, you can also set drools configuration properties (but be careful of backwards compatibility
          issues):</p><pre><code class="language-xml">  &lt;scoreDirectorFactory&gt;
    ...
    &lt;scoreDrl&gt;org/optaplanner/examples/nqueens/solver/nQueensScoreRules.drl&lt;/scoreDrl&gt;
    &lt;kieBaseConfigurationProperties&gt;
      &lt;drools.equalityBehavior&gt;...&lt;/drools.equalityBehavior&gt;
    &lt;/kieBaseConfigurationProperties&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre></div><div class="section" title="5.3.4.2.2. A scoreDrlFile"><div class="titlepage"><div><div><h5 class="title"><a id="droolsScoreCalculationScoreDrlFile"/>5.3.4.2.2. A scoreDrlFile</h5></div></div></div><p>To use <code class="literal">File</code> on the local file system, instead of a classpath resource, add the score
          rules DRL file in the solver configuration as a <code class="literal">&lt;scoreDrlFile&gt;</code> element:</p><pre><code class="language-xml">  &lt;scoreDirectorFactory&gt;
    &lt;scoreDefinitionType&gt;...&lt;/scoreDefinitionType&gt;
    &lt;scoreDrlFile&gt;/home/ge0ffrey/tmp/nQueensScoreRules.drl&lt;/scoreDrlFile&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Warning</h2><p>For portability reasons, a classpath resource is recommended over a File. An application build on one
            computer, but used on another computer, might not find the file on the same location. Worse, if they use a
            different Operating System, it is hard to choose a portable file path.</p></div><p>Add multiple <code class="literal">&lt;scoreDrlFile&gt;</code> elements if the score rules are split across
          multiple DRL files.</p></div><div class="section" title="5.3.4.2.3. A ksessionName in a Kjar from a Maven repository"><div class="titlepage"><div><div><h5 class="title"><a id="droolsScoreCalculationKsessionName"/>5.3.4.2.3. A ksessionName in a Kjar from a Maven repository</h5></div></div></div><p>This way allows you to use score rules defined by the Workbench or build a kjar and deploy it to the
          Execution Server. Both the score rules and the solver configuration are resources in a kjar. Clients can
          obtain that kjar either from the local classpath, from a local Maven repository or even from a remote Maven
          repository.</p><p>The score rules still live in a DRL file, but the <code class="literal">KieContainer</code> finds it through the
          <code class="literal">META-INF/kmodule.xml</code> file:</p><pre><code class="language-xml">&lt;kmodule xmlns="http://www.drools.org/xsd/kmodule"&gt;
  &lt;kbase name="nQueensKbase" packages="org.optaplanner.examples.nqueens.solver"&gt;
    &lt;ksession name="nQueensKsession"/&gt;
  &lt;/kbase&gt;
&lt;/kmodule&gt;</code></pre><p>The kmodule above will pick up all the DRL files in the package
          <code class="literal">org.optaplanner.examples.nqueens.solver</code>. A kbase can even extend another kbase.</p><p>Add the ksession name in the solver configuration as a <code class="literal">&lt;ksessionName&gt;</code>
          element:</p><pre><code class="language-xml">  &lt;scoreDirectorFactory&gt;
    &lt;scoreDefinitionType&gt;...&lt;/scoreDefinitionType&gt;
    &lt;ksessionName&gt;nQueensKsession&lt;/ksessionName&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre><p>When using this approach, it's required to use a
          <code class="literal">SolverFactory.createFromKieContainerXmlResource(...)</code> method to build the
          <code class="literal">SolverFactory</code>.</p></div></div><div class="section" title="5.3.4.3. Implementing a Score Rule"><div class="titlepage"><div><div><h4 class="title"><a id="implementingAScoreRule"/>5.3.4.3. Implementing a Score Rule</h4></div></div></div><p>Here is an example of a score constraint implemented as a score rule in a DRL file:</p><pre><code class="no-highlight">rule "multipleQueensHorizontal"
    when
        Queen($id : id, row != null, $i : rowIndex)
        Queen(id &gt; $id, rowIndex == $i)
    then
        scoreHolder.addConstraintMatch(kcontext, -1);
end</code></pre><p>This score rule will fire once for every 2 queens with the same <code class="literal">rowIndex</code>. The
        <code class="literal">(id &gt; $id)</code> condition is needed to assure that for 2 queens A and B, it can only fire for
        (A, B) and not for (B, A), (A, A) or (B, B). Let us take a closer look at this score rule on this solution of 4
        queens:</p><div class="mediaobject"><img src="images/Chapter-Score_calculation/unsolvedNQueens04.png"/></div><p>In this solution the multipleQueensHorizontal score rule will fire for 6 queen couples: (A, B), (A, C),
        (A, D), (B, C), (B, D) and (C, D). Because none of the queens are on the same vertical or diagonal line, this
        solution will have a score of <code class="literal">-6</code>. An optimal solution of 4 queens has a score of
        <code class="literal">0</code>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>Notice that every score rule will relate to at least one planning entity class (directly or indirectly
          through a logically inserted fact).</p><p>This is a normal case. It would be a waste of time to write a score rule that only relates to problem
          facts, as the consequence will never change during planning, no matter what the possible solution.</p></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>The <code class="literal">kcontext</code> variable is a magic variable in Drools Expert. The
          <code class="literal">scoreHolder</code>'s method uses it to do incremental score calculation correctly and to create a
          <code class="literal">ConstraintMatch</code> instance.</p></div></div><div class="section" title="5.3.4.4. Weighing Score Rules"><div class="titlepage"><div><div><h4 class="title"><a id="weighingScoreRules"/>5.3.4.4. Weighing Score Rules</h4></div></div></div><p>A <code class="literal">ScoreHolder</code> instance is asserted into the <code class="literal">KieSession</code> as a global
        called <code class="literal">scoreHolder</code>. The score rules need to (directly or indirectly) update that
        instance.</p><pre><code class="no-highlight">global SimpleScoreHolder scoreHolder;

rule "multipleQueensHorizontal"
    when
        Queen($id : id, row != null, $i : rowIndex)
        Queen(id &gt; $id, rowIndex == $i)
    then
        scoreHolder.addConstraintMatch(kcontext, -1);
end

// multipleQueensVertical is obsolete because it is always 0

rule "multipleQueensAscendingDiagonal"
    when
        Queen($id : id, row != null, $i : ascendingDiagonalIndex)
        Queen(id &gt; $id, ascendingDiagonalIndex == $i)
    then
        scoreHolder.addConstraintMatch(kcontext, -1);
end

rule "multipleQueensDescendingDiagonal"
    when
        Queen($id : id, row != null, $i : descendingDiagonalIndex)
        Queen(id &gt; $id, descendingDiagonalIndex == $i)
    then
        scoreHolder.addConstraintMatch(kcontext, -1);
end</code></pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>To learn more about the Drools rule language (DRL), consult <a class="link" href="http://drools.org/learn/documentation.html">the Drools documentation</a>.</p></div><p>Most use cases also weigh their constraint types or even their matches differently, by using a specific
        weight for each constraint match. For example in <a class="link" href="ch03.html#curriculumCourse" title="3.3.1. Course Timetabling (ITC 2007 Track 3 - Curriculum Course Scheduling)">course scheduling</a>,
        assigning a <code class="literal">Lecture</code> to a <code class="literal">Room</code> that is lacking two seats is weighted
        equally bad as having one isolated <code class="literal">Lecture</code> in a <code class="literal">Curriculum</code>:</p><pre><code class="no-highlight">global HardSoftScoreHolder scoreHolder;

// RoomCapacity: For each lecture, the number of students that attend the course must be less or equal
// than the number of seats of all the rooms that host its lectures.
rule "roomCapacity"
    when
        $room : Room($capacity : capacity)
        $lecture : Lecture(room == $room, studentSize &gt; $capacity, $studentSize : studentSize)
    then
        // Each student above the capacity counts as 1 point of penalty.
        scoreHolder.addSoftConstraintMatch(kcontext, ($capacity - $studentSize));
end

// CurriculumCompactness: Lectures belonging to a curriculum should be adjacent
// to each other (i.e., in consecutive periods).
// For a given curriculum we account for a violation every time there is one lecture not adjacent
// to any other lecture within the same day.
rule "curriculumCompactness"
    when
        ...
    then
        // Each isolated lecture in a curriculum counts as 2 points of penalty.
        scoreHolder.addSoftConstraintMatch(kcontext, -2);
end</code></pre></div></div><div class="section" title="5.3.5. InitializingScoreTrend"><div class="titlepage"><div><div><h3 class="title"><a id="initializingScoreTrend"/>5.3.5. InitializingScoreTrend</h3></div></div></div><p>The <code class="literal">InitializingScoreTrend</code> specifies how the Score will change as more and more variables
      are initialized (while the already initialized variables do not change). Some optimization algorithms (such
      Construction Heuristics and Exhaustive Search) run faster if they have such information.</p><p>For for the Score (or each <a class="link" href="ch05.html#scoreLevel" title="5.1.4. Score Constraint Level (hard, soft, ...)">score level</a> separately), specify a
      trend:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="literal">ANY</code> (default): Initializing an extra variable can change the score positively or
          negatively. Gives no performance gain.</p></li><li class="listitem"><p><code class="literal">ONLY_UP</code> (rare): Initializing an extra variable can only change the score positively.
          Implies that:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>There are only positive constraints</p></li><li class="listitem"><p>And initializing the next variable can not unmatch a positive constraint that was matched by a
              previous initialized variable.</p></li></ul></div></li><li class="listitem"><p><code class="literal">ONLY_DOWN</code>: Initializing an extra variable can only change the score negatively.
          Implies that:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>There are only negative constraints</p></li><li class="listitem"><p>And initializing the next variable can not unmatch a negative constraint that was matched by a
              previous initialized variable.</p></li></ul></div></li></ul></div><p>Most use cases only have negative constraints. Many of those have an
      <code class="literal">InitializingScoreTrend</code> that only goes down:</p><pre><code class="language-xml">  &lt;scoreDirectorFactory&gt;
    &lt;scoreDefinitionType&gt;HARD_SOFT&lt;/scoreDefinitionType&gt;
    &lt;scoreDrl&gt;.../cloudBalancingScoreRules.drl&lt;/scoreDrl&gt;
    &lt;initializingScoreTrend&gt;ONLY_DOWN&lt;/initializingScoreTrend&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre><p>Alternatively, you can also specify the trend for each score level separately:</p><pre><code class="language-xml">  &lt;scoreDirectorFactory&gt;
    &lt;scoreDefinitionType&gt;HARD_SOFT&lt;/scoreDefinitionType&gt;
    &lt;scoreDrl&gt;.../cloudBalancingScoreRules.drl&lt;/scoreDrl&gt;
    &lt;initializingScoreTrend&gt;ONLY_DOWN/ONLY_DOWN&lt;/initializingScoreTrend&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre></div><div class="section" title="5.3.6. Invalid Score Detection"><div class="titlepage"><div><div><h3 class="title"><a id="invalidScoreDetection"/>5.3.6. Invalid Score Detection</h3></div></div></div><p>Put the <code class="literal">environmentMode</code> in <code class="literal">FULL_ASSERT</code> (or
      <code class="literal">FAST_ASSERT</code>) to detect corruption in the <a class="link" href="ch05.html#incrementalScoreCalculation" title="5.4.3. Incremental Score Calculation (with Deltas)">incremental score calculation</a>. For more information, <a class="link" href="ch04.html#environmentMode" title="4.4.3. Environment Mode: Are There Bugs in my Code?">see the section about <code class="literal">environmentMode</code></a>. However, that will not
      verify that your score calculator implements your score constraints as your business actually desires.</p><p>A piece of incremental score calculator code can be difficult to write and to review. Assert its correctness
      by using a different implementation (for example a <code class="literal">EasyScoreCalculator</code>) to do the assertions
      triggered by the <code class="literal">environmentMode</code>. Just configure the different implementation as a
      <code class="literal">assertionScoreDirectorFactory</code>:</p><pre><code class="language-xml">  &lt;environmentMode&gt;FAST_ASSERT&lt;/environmentMode&gt;
  ...
  &lt;scoreDirectorFactory&gt;
    &lt;scoreDefinitionType&gt;...&lt;/scoreDefinitionType&gt;
    &lt;scoreDrl&gt;org/optaplanner/examples/nqueens/solver/nQueensScoreRules.drl&lt;/scoreDrl&gt;
    &lt;assertionScoreDirectorFactory&gt;
      &lt;easyScoreCalculatorClass&gt;org.optaplanner.examples.nqueens.solver.score.NQueensEasyScoreCalculator&lt;/easyScoreCalculatorClass&gt;
    &lt;/assertionScoreDirectorFactory&gt;
  &lt;/scoreDirectorFactory&gt;</code></pre><p>This way, the <code class="literal">scoreDrl</code> will be validated by the
      <code class="literal">EasyScoreCalculator</code>.</p></div></div><div class="section" title="5.4. Score Calculation Performance Tricks"><div class="titlepage"><div><div><h2 class="title"><a id="scoreCalculationPerformanceTricks"/>5.4. Score Calculation Performance Tricks</h2></div></div></div><div class="section" title="5.4.1. Overview"><div class="titlepage"><div><div><h3 class="title"><a id="scoreCalculationPerformanceTricksOverview"/>5.4.1. Overview</h3></div></div></div><p>The <code class="literal">Solver</code> will normally spend most of its execution time running the score calculation
      (which is called in its deepest loops). Faster score calculation will return the same solution in less time with
      the same algorithm, which normally means a better solution in equal time.</p></div><div class="section" title="5.4.2. Average Calculation Count Per Second"><div class="titlepage"><div><div><h3 class="title"><a id="averageCalculationCountPerSecond"/>5.4.2. Average Calculation Count Per Second</h3></div></div></div><p>After solving a problem, the <code class="literal">Solver</code> will log the <span class="emphasis"><em>average calculation count per
      second</em></span>. This is a good measurement of Score calculation performance, despite that it is affected by non
      score calculation execution time. It depends on the problem scale of the problem dataset. Normally, even for high
      scale problems, it is higher than <code class="literal">1000</code>, except when you are using
      <code class="literal">EasyScoreCalculator</code>.</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2><p>When improving your score calculation, focus on maximizing the average calculation count per second,
        instead of maximizing the best score. A big improvement in score calculation can sometimes yield little or no
        best score improvement, for example when the algorithm is stuck in a local or global optima. If you are watching
        the calculation count instead, score calculation improvements are far more visible.</p><p>Furthermore, watching the calculation count, allows you to remove or add score constraints, and still
        compare it with the original calculation count. Comparing the best score with the original would be wrong,
        because it is comparing apples and oranges.</p></div></div><div class="section" title="5.4.3. Incremental Score Calculation (with Deltas)"><div class="titlepage"><div><div><h3 class="title"><a id="incrementalScoreCalculation"/>5.4.3. Incremental Score Calculation (with Deltas)</h3></div></div></div><p>When a <code class="literal">Solution</code> changes, incremental score calculation (AKA delta based score
      calculation), will calculate the delta with the previous state to find the new <code class="literal">Score</code>, instead
      of recalculating the entire score on every solution evaluation.</p><p>For example, if a single queen A moves from row <code class="literal">1</code> to <code class="literal">2</code>, it will not
      bother to check if queen B and C can attack each other, since neither of them changed.</p><div class="figure"><a id="d0e6783"/><p class="title"><strong>Figure 5.1. Incremental Score Calculation for the 4 Queens Puzzle</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/Chapter-Score_calculation/incrementalScoreCalculationNQueens04.png" alt="Incremental Score Calculation for the 4 Queens Puzzle"/></div></div></div><br class="figure-break"/><p>This is a huge performance and scalability gain. <span class="bold"><strong>Drools score calculation gives you
      this huge scalability gain without forcing you to write a complicated incremental score calculation
      algorithm.</strong></span> Just let the Drools rule engine do the hard work.</p><p>Notice that the speedup is relative to the size of your planning problem (your <span class="emphasis"><em>n</em></span>),
      making incremental score calculation far more scalable.</p></div><div class="section" title="5.4.4. Avoid Calling Remote Services During Score Calculation"><div class="titlepage"><div><div><h3 class="title"><a id="avoidCallingRemoteServicesDuringScoreCalculation"/>5.4.4. Avoid Calling Remote Services During Score Calculation</h3></div></div></div><p>Do not call remote services in your score calculation (except if you are bridging
      <code class="literal">EasyScoreCalculator</code> to a legacy system). The network latency will kill your score calculation
      performance. Cache the results of those remote services if possible.</p><p>If some parts of a constraint can be calculated once, when the <code class="literal">Solver</code> starts, and never
      change during solving, then turn them into <a class="link" href="ch04.html#cachedProblemFact" title="4.3.7.5.1. Cached Problem Fact">cached problem facts</a>.</p></div><div class="section" title="5.4.5. Pointless Constraints"><div class="titlepage"><div><div><h3 class="title"><a id="pointlessConstraints"/>5.4.5. Pointless Constraints</h3></div></div></div><p>If you know a certain constraint can never be broken (or it is always broken), you need not write a score
      constraint for it. For example in n queens, the score calculation does not check if multiple queens occupy the
      same column, because a <code class="literal">Queen</code>'s <code class="literal">column</code> never changes and every
      <code class="literal">Solution</code> starts with each <code class="literal">Queen</code> on a different
      <code class="literal">column</code>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>Do not go overboard with this. If some datasets do not use a specific constraint but others do, just
        return out of the constraint as soon as you can. There is no need to dynamically change your score calculation
        based on the dataset.</p></div></div><div class="section" title="5.4.6. Built-in Hard Constraint"><div class="titlepage"><div><div><h3 class="title"><a id="buildInHardConstraint"/>5.4.6. Built-in Hard Constraint</h3></div></div></div><p>Instead of implementing a hard constraint, it can sometimes be built in. For example, If
      <code class="literal">Lecture</code> A should never be assigned to <code class="literal">Room</code> X, but it uses
      <code class="literal">ValueRangeProvider</code> on Solution, so the <code class="literal">Solver</code> will often try to assign it to
      <code class="literal">Room</code> X too (only to find out that it breaks a hard constraint). Use <a class="link" href="ch04.html#valueRangeProviderOnPlanningEntity" title="4.3.5.2.3. ValueRangeProvider on the Planning Entity">a ValueRangeProvider on the planning entity</a> or <a class="link" href="ch07.html#filteredSelection" title="7.6.4. Filtered Selection">filtered selection</a> to define that Course A should only be assigned a
      <code class="literal">Room</code> different than X.</p><p>This can give a good performance gain in some use cases, not just because the score calculation is faster,
      but mainly because most optimization algorithms will spend less time evaluating unfeasible solutions. However,
      usually this not a good idea because there is a real risk of trading short term benefits for long term
      harm:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Many optimization algorithms rely on the freedom to break hard constraints when changing planning
          entities, to get out of local optima.</p></li><li class="listitem"><p>Both implementation approaches have limitations (feature compatibility, disabling automatic performance
          optimizations), as explained in their documentation.</p></li></ul></div></div><div class="section" title="5.4.7. Other Score Calculation Performance Tricks"><div class="titlepage"><div><div><h3 class="title"><a id="otherScoreCalculationPerformanceTricks"/>5.4.7. Other Score Calculation Performance Tricks</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Verify that your score calculation happens in the correct <code class="literal">Number</code> type. If you are
          making the sum of <code class="literal">int</code> values, do not let Drools sum it in a <code class="literal">double</code> which
          takes longer.</p></li><li class="listitem"><p>For optimal performance, always use server mode (<code class="literal">java -server</code>). We have seen
          performance increases of 50% by turning on server mode.</p></li><li class="listitem"><p>For optimal performance, use the latest Java version. For example, in the past we have seen performance
          increases of 30% by switching from java 1.5 to 1.6.</p></li><li class="listitem"><p>Always remember that premature optimization is the root of all evil. Make sure your design is flexible
          enough to allow configuration based tweaking.</p></li></ul></div></div><div class="section" title="5.4.8. Score Trap"><div class="titlepage"><div><div><h3 class="title"><a id="scoreTrap"/>5.4.8. Score Trap</h3></div></div></div><p>Make sure that none of your score constraints cause a score trap. A trapped score constraint uses the same
      weight for different constraint matches, when it could just as easily use a different weight. It effectively lumps
      its constraint matches together, which creates a flatlined score function for that constraint. This can cause a
      solution state in which several moves need to be done to resolve or lower the weight of that single constraint.
      Some examples of score traps:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>You need two doctors at each table, but you are only moving one doctor at a time. So the solver has no
          incentive to move a doctor to a table with no doctors. Punish a table with no doctors more then a table with
          only one doctor in that score constraint in the score function.</p></li><li class="listitem"><p>Two exams need to be conducted at the same time, but you are only moving one exam at a time. So the
          solver has to move one of those exams to another timeslot without moving the other in the same move. Add a
          coarse-grained move that moves both exams at the same time.</p></li></ul></div><p>For example, consider this score trap. If the blue item moves from an overloaded computer to an empty
      computer, the hard score should improve. The trapped score implementation fails to do that:</p><div class="mediaobject"><img src="images/Chapter-Score_calculation/scoreTrap.png"/></div><p>The Solver should eventually get out of this trap, but it will take a lot of effort (especially if there are
      even more processes on the overloaded computer). Before they do that, they might actually start moving more
      processes into that overloaded computer, as there is no penalty for doing so.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>Avoiding score traps does not mean that your score function should be smart enough to avoid local optima.
        Leave it to the optimization algorithms to deal with the local optima.</p><p>Avoiding score traps means to avoid, for each score constraint individually, a flatlined score
        function.</p></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Important</h2><p>Always specify the degree of infeasibility. The business will often say "if the solution is infeasible, it
        does not matter how infeasible it is." While that is true for the business, it is not true for score calculation
        as it benefits from knowing how infeasible it is. In practice, soft constraints usually do this naturally and it
        is just a matter of doing it for the hard constraints too.</p></div><p>There are several ways to deal with a score trap:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Improve the score constraint to make a distinction in the score weight. For example, penalize
          <code class="literal">-1hard</code> for every missing CPU, instead of just <code class="literal">-1hard</code> if any CPU is
          missing.</p></li><li class="listitem"><p>If changing the score constraint is not allowed from the business perspective, add a lower score level
          with a score constraint that makes such a distinction. For example, penalize <code class="literal">-1subsoft</code> for
          every missing CPU, on top of <code class="literal">-1hard</code> if any CPU is missing. The business ignores the subsoft
          score level.</p></li><li class="listitem"><p>Add coarse-grained moves and union select them with the existing fine-grained moves. A coarse-grained
          move effectively does multiple moves to directly get out of a score trap with a single move. For example, move
          multiple items from the same container to another container.</p></li></ul></div></div><div class="section" title="5.4.9. stepLimit Benchmark"><div class="titlepage"><div><div><h3 class="title"><a id="stepLimitBenchmark"/>5.4.9. stepLimit Benchmark</h3></div></div></div><p>Not all score constraints have the same performance cost. Sometimes one score constraint can kill the score
      calculation performance outright. Use the <a class="link" href="ch14.html" title="Chapter 14. Benchmarking And Tweaking">Benchmarker</a> to do a one minute run
      and check what happens to the average calculation count per second if you comment out all but one of the score
      constraints.</p></div><div class="section" title="5.4.10. Fairness Score Constraints"><div class="titlepage"><div><div><h3 class="title"><a id="fairnessScoreConstraints"/>5.4.10. Fairness Score Constraints</h3></div></div></div><p>Some use cases have a business requirement to provide a fair schedule (usually as a soft score constraint),
      for example:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Fairly distribute the workload amongst the employees, to avoid envy.</p></li><li class="listitem"><p>Evenly distribute the workload amongst assets, to improve reliability.</p></li></ul></div><p>Implementing such a constraint can seem difficult (especially because there are different ways to formalize
      fairness), but usually the <span class="emphasis"><em>squared workload</em></span> implementation behaves most desirable. For each
      employee/asset, count the workload <code class="literal">w</code> and subtract <code class="literal">w²</code> from the score.</p><div class="mediaobject"><img src="images/Chapter-Score_calculation/fairnessScoreConstraint.png"/></div><p>As shown above, the <span class="emphasis"><em>squared workload</em></span> implementation guarantees that if you select two
      employees from a given solution and make their distribution between those two employees fairer, then the resulting
      new solution will have a better overall score. Don not just use the difference from the average workload, as that
      can lead to unfairness, as demonstrated below.</p><div class="mediaobject"><img src="images/Chapter-Score_calculation/fairnessScoreConstraintPitfall.png"/></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p>Instead of the <span class="emphasis"><em>squared workload</em></span>, it is also possible to use the <a class="link" href="http://en.wikipedia.org/wiki/Variance">variance</a> (squared difference to the average) or the
        <a class="link" href="http://en.wikipedia.org/wiki/Standard_deviation">standard deviation</a> (square root of the
        variance). This has no effect on the score comparison, because the average will not change during planning. It
        is just more work to implement (because the average needs to be known) and trivially slower (because the
        calculation is a bit longer).</p></div><p>When the workload is perfect balanced, the user often likes to see a <code class="literal">0</code> score, instead of
      the distracting <code class="literal">-34soft</code> in the image above (for the last solution which is almost perfectly
      balanced). To nullify this, either add the average multiplied by the number of entities to the score or instead
      show the variance or standard deviation in the UI.</p></div></div><div class="section" title="5.5. Explaining the Score: Using Score Calculation Outside the Solver"><div class="titlepage"><div><div><h2 class="title"><a id="explainingTheScore"/>5.5. Explaining the Score: Using Score Calculation Outside the <code class="literal">Solver</code></h2></div></div></div><p>Other parts of your application, for example your webUI, might need to calculate the score too. Do that by
    reusing the <code class="literal">ScoreDirectorFactory</code> of the <code class="literal">Solver</code> to build a separate
    <code class="literal">ScoreDirector</code> for that webUI:</p><pre><code class="language-java">ScoreDirectorFactory scoreDirectorFactory = solver.getScoreDirectorFactory();
ScoreDirector guiScoreDirector = scoreDirectorFactory.buildScoreDirector();</code></pre><p>Then use it when you need to calculate the <code class="literal">Score</code> of a <code class="literal">Solution</code>:</p><pre><code class="language-java">guiScoreDirector.setWorkingSolution(solution);
Score score = guiScoreDirector.calculateScore();</code></pre><p>To explain in the GUI what entities are causing which part of the <code class="literal">Score</code>, get the
    <code class="literal">ConstraintMatch</code> objects from the <code class="literal">ScoreDirector</code>:</p><pre><code class="language-java">for (ConstraintMatchTotal constraintMatchTotal : guiScoreDirector.getConstraintMatchTotals()) {
    String constraintName = constraintMatchTotal.getConstraintName();
    Number weightTotal = constraintMatchTotal.getWeightTotalAsNumber();
    for (ConstraintMatch constraintMatch : constraintMatchTotal.getConstraintMatchSet()) {
        List&lt;Object&gt; justificationList = constraintMatch.getJustificationList();
        Number weight = constraintMatch.getWeightAsNumber();
        ...
    }
}</code></pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h2>Note</h2><p><a class="link" href="ch05.html#droolsScoreCalculation" title="5.3.4. Drools Score Calculation">Drools score calculation</a> supports constraint matches
      automatically, but <a class="link" href="ch05.html#incrementalJavaScoreCalculation" title="5.3.3. Incremental Java Score Calculation">incremental Java score calculation</a>
      requires requires implementing an extra interface (see that section).</p></div></div></div><script type="text/javascript" src="highlight.js/highlight.pack.js"> </script><script type="text/javascript">hljs.initHighlightingOnLoad();</script><script type="text/javascript">
dataLayer = [{'channel' : 'OptaPlanner', 'additional_tracking_code' : 'UA-39485370-1'}];
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NJWS5L');</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-NJWS5L" height="0" width="0" style="display:none;visibility:hidden"> </iframe></noscript><ul class="docnav"><li class="previous"><a accesskey="p" href="ch04.html"><strong>Prev</strong>Chapter 4. Planner Configuration</a></li><li class="up"><a accesskey="u" href="#"><strong>Up</strong></a></li><li class="home"><a accesskey="h" href="index.html"><strong>Home</strong></a></li><li class="next"><a accesskey="n" href="ch06.html"><strong>Next</strong>Chapter 6. Optimization Algorithms</a></li></ul></body></html>